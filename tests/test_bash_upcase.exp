#!/usr/bin/expect -f
# Test: Type text in bash, upcase word with M-u, quit
set timeout 10

spawn bash --norc --noprofile -c "source ./em.sh && em"

expect {
    "bad emacs" { puts "\nPASS: editor started" }
    timeout { puts "\nFAIL: editor did not start"; exit 1 }
}

# Type text
send "hello"
sleep 0.5

# C-a to go to beginning of line
send "\x01"
sleep 0.5

# M-u (ESC then u) to upcase word
send "\x1b"
sleep 0.15
send "u"
sleep 0.5

expect {
    "HELLO" { puts "PASS: upcase word worked" }
    timeout { puts "FAIL: upcase not visible"; exit 1 }
}

# C-x C-c to quit (buffer is modified, decline save)
send "\x18\x03"
sleep 0.3

expect {
    "Save*" {
        send "n"
        expect {
            eof { puts "PASS: exited after declining save" }
            timeout { puts "FAIL: did not exit after declining"; exit 1 }
        }
    }
    eof { puts "PASS: editor exited cleanly" }
    timeout { puts "FAIL: editor did not exit"; exit 1 }
}

puts "TEST PASSED: bash upcase word"

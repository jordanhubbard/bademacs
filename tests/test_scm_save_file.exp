#!/usr/bin/expect -f
# Test: Type text in Scheme editor, save to file, verify content, quit
set timeout 300 ; # Scheme startup (bs loads ~1300 lines) is slow on CI

set testfile "/tmp/em_scm_test_save_output.txt"
file delete -force $testfile

spawn bash [file join [file dirname [info script]] .. em.scm.sh] $testfile

expect {
    "shemacs" { puts "\nPASS: editor started" }
    timeout { puts "\nFAIL: editor did not start"; exit 1 }
}

set timeout 30 ; # operations after startup are fast

# Type text
send "Hello from scheme em"
sleep 2

# C-x C-s to save
send "\x18\x13"

expect {
    -re "Wrote.*line" { puts "PASS: file saved" }
    timeout { puts "FAIL: save not confirmed"; exit 1 }
}

# C-x C-c to quit
send "\x18\x03"

expect {
    eof { puts "PASS: editor exited cleanly" }
    timeout { puts "FAIL: editor did not exit"; exit 1 }
}

# Verify saved content
set fd [open $testfile r]
set content [read $fd]
close $fd
if {[string match "*Hello from scheme em*" $content]} {
    puts "PASS: saved content verified"
} else {
    puts "FAIL: saved content mismatch: $content"
    exit 1
}

puts "TEST PASSED: scheme save file"

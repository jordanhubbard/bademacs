#!/usr/bin/expect -f
# Test: Type text in bash, save to file, verify content, quit
set timeout 10

set testfile "/tmp/em_test_save_output.txt"
file delete -force $testfile

spawn bash --norc --noprofile ./em.sh $testfile

expect {
    "bad emacs" { puts "\nPASS: editor started" }
    timeout { puts "\nFAIL: editor did not start"; exit 1 }
}

# Type text
send "Hello from bash em"
sleep 0.5

# C-x C-s to save
send "\x18\x13"

expect {
    -re "Wrote.*line" { puts "PASS: file saved" }
    timeout { puts "FAIL: save not confirmed"; exit 1 }
}

# C-x C-c to quit
send "\x18\x03"

expect {
    eof { puts "PASS: editor exited cleanly" }
    timeout { puts "FAIL: editor did not exit"; exit 1 }
}

# Verify saved content
set fd [open $testfile r]
set content [read $fd]
close $fd
if {[string match "*Hello from bash em*" $content]} {
    puts "PASS: saved content verified"
} else {
    puts "FAIL: saved content mismatch: $content"
    exit 1
}

puts "TEST PASSED: bash save file"
